#!/usr/bin/env python3
"""Compile comprehensive results from registry metadata and gmcpt test attempts."""

import json
import os

SERVERS_JSON = "/home/user/research/mcplist/registry_servers.json"
RESULTS_DIR = "/home/user/research/mcplist/results"
OUTPUT_FILE = "/home/user/research/mcplist/mcp_servers.txt"

with open(SERVERS_JSON) as f:
    servers = json.load(f)

# Parse individual result files
parsed_results = []
for i, server in enumerate(servers):
    result_file = os.path.join(RESULTS_DIR, f"server_{i}.txt")

    status = "not_tested"
    raw_output = ""
    gmcpt_auth_required = None
    tools = []
    prompts = []
    resources = []

    if os.path.exists(result_file):
        with open(result_file) as f:
            content = f.read()

        for line in content.split('\n'):
            if line.startswith('STATUS: '):
                status = line[8:].strip()

        output_start = content.find('OUTPUT:')
        output_end = content.find('\n---')
        if output_start >= 0:
            raw_output = content[output_start + 8:output_end].strip()

        if status == 'success':
            gmcpt_auth_required = False
            try:
                data = json.loads(raw_output)
                tools = [t.get('name', '') for t in data.get('tools', [])]
                prompts = [p.get('name', '') for p in data.get('prompts', [])]
                resources = [r.get('name', r.get('uri', '')) for r in data.get('resources', [])]
            except (json.JSONDecodeError, TypeError):
                pass
        elif status == 'auth_required':
            gmcpt_auth_required = True

    # Determine auth from registry metadata
    auth_headers = server.get('auth_headers', [])
    registry_auth = bool(auth_headers)
    auth_header_names = [h['name'] for h in auth_headers]

    # Determine SSE or not
    is_sse = server['transport_type'] == 'sse'

    parsed_results.append({
        'name': server['name'],
        'url': server['url'],
        'description': server.get('description', ''),
        'version': server.get('version', ''),
        'transport_type': server['transport_type'],
        'is_sse': is_sse,
        'registry_auth': registry_auth,
        'auth_header_names': auth_header_names,
        'gmcpt_status': status,
        'gmcpt_auth_required': gmcpt_auth_required,
        'tools': tools,
        'prompts': prompts,
        'resources': resources,
        'error_snippet': raw_output[:200] if status not in ('success', 'connection_blocked') else '',
    })

# Write results
with open(OUTPUT_FILE, 'w') as f:
    f.write("MCP Server Registry - Authentication & Capabilities Report\n")
    f.write("Generated by gmcpt list against registry.modelcontextprotocol.io\n")
    f.write("=" * 78 + "\n\n")

    # Summary
    total = len(parsed_results)
    sse_count = sum(1 for r in parsed_results if r['is_sse'])
    streamable_count = sum(1 for r in parsed_results if not r['is_sse'])
    auth_required = sum(1 for r in parsed_results if r['registry_auth'])
    no_auth = sum(1 for r in parsed_results if not r['registry_auth'])
    gmcpt_success = sum(1 for r in parsed_results if r['gmcpt_status'] == 'success')
    gmcpt_auth = sum(1 for r in parsed_results if r['gmcpt_status'] == 'auth_required')
    gmcpt_blocked = sum(1 for r in parsed_results if r['gmcpt_status'] == 'connection_blocked')
    gmcpt_failed = sum(1 for r in parsed_results if r['gmcpt_status'] == 'connection_failed')
    gmcpt_error = sum(1 for r in parsed_results if r['gmcpt_status'] == 'error')

    f.write(f"SUMMARY\n")
    f.write(f"  Total remote MCP servers: {total}\n")
    f.write(f"  SSE transport: {sse_count}\n")
    f.write(f"  Streamable HTTP transport: {streamable_count}\n")
    f.write(f"\n")
    f.write(f"  Auth required (per registry metadata): {auth_required}\n")
    f.write(f"  No auth metadata: {no_auth}\n")
    f.write(f"\n")
    f.write(f"  gmcpt list results:\n")
    f.write(f"    Successful: {gmcpt_success}\n")
    f.write(f"    Auth required (confirmed by server): {gmcpt_auth}\n")
    f.write(f"    Connection blocked (egress proxy): {gmcpt_blocked}\n")
    f.write(f"    Connection failed: {gmcpt_failed}\n")
    f.write(f"    Other error: {gmcpt_error}\n")
    f.write("\n" + "=" * 78 + "\n\n")

    # Detailed listing
    for r in parsed_results:
        f.write(f"Server: {r['name']}\n")
        f.write(f"  URL: {r['url']}\n")
        f.write(f"  SSE: {'yes' if r['is_sse'] else 'no'}\n")
        f.write(f"  Transport: {r['transport_type']}\n")

        # Auth info
        if r['registry_auth']:
            f.write(f"  Auth Required: yes (headers: {', '.join(r['auth_header_names'])})\n")
        elif r['gmcpt_auth_required'] is True:
            f.write(f"  Auth Required: yes (confirmed by gmcpt)\n")
        elif r['gmcpt_auth_required'] is False:
            f.write(f"  Auth Required: no\n")
        else:
            f.write(f"  Auth Required: unknown\n")

        # gmcpt connection result
        f.write(f"  gmcpt Status: {r['gmcpt_status']}\n")

        # Capabilities
        if r['tools']:
            f.write(f"  Tools: {', '.join(r['tools'])}\n")
        if r['prompts']:
            f.write(f"  Prompts: {', '.join(r['prompts'])}\n")
        if r['resources']:
            f.write(f"  Resources: {', '.join(r['resources'])}\n")

        if r['error_snippet']:
            f.write(f"  Error: {r['error_snippet']}\n")

        f.write("\n")

print(f"Wrote {OUTPUT_FILE} with {total} servers")
